{% extends "base.html" %}

{% block title %}Fly.io Management - GBot Web{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
    <h1 class="glass-text-primary mb-0" style="font-size: 2rem; font-weight: 700;">
        <i class="fas fa-plane-departure me-3"></i>Fly.io Management
    </h1>
    <div class="d-flex align-items-center gap-3">
        <span class="badge badge-success glass-badge px-3 py-2">
            <i class="fas fa-signal me-1"></i> Platform Online
        </span>
    </div>
</div>

<!-- Info Message -->
<div class="glass-panel p-4 mb-5" style="border-left: 4px solid var(--accent-secondary) !important;">
    <div class="d-flex align-items-start gap-3">
        <div class="glass-orb"
            style="position: static; width: 24px; height: 24px; background: var(--accent-secondary); filter: blur(10px); opacity: 0.8;">
        </div>
        <div>
            <h5 class="mb-1" style="color: var(--accent-secondary);">Ephemeral Worker Platform</h5>
            <p class="mb-0 text-muted">
                Fly.io provides on-demand machines with dedicated IPs for parallel processing.
                Each machine runs independently and destroys automatically after completion.
            </p>
        </div>
    </div>
</div>

<!-- Main Interface -->
<div class="glass-panel p-0 overflow-hidden mb-5">
    <!-- Glass Tabs -->
    <div class="d-flex border-bottom border-white-10 p-3 gap-3">
        <button class="glass-button tab-button active" onclick="switchTab('infrastructure')"
            id="tab-infrastructure-btn">
            <i class="fas fa-rocket me-2"></i>Infrastructure
        </button>
        <button class="glass-button tab-button" onclick="switchTab('machines')" id="tab-machines-btn">
            <i class="fas fa-server me-2"></i>Machines
        </button>
        <button class="glass-button tab-button" onclick="switchTab('processing')" id="tab-processing-btn">
            <i class="fas fa-cogs me-2"></i>Processing
        </button>
        <button class="glass-button tab-button" onclick="switchTab('status')" id="tab-status-btn">
            <i class="fas fa-chart-bar me-2"></i>Status
        </button>
    </div>

    <div class="p-4">
        <!-- Tab: Infrastructure -->
        <div id="tab-infrastructure" class="tab-content active">
            <h4 class="mb-4 glass-text-primary">App Setup & Deployment</h4>

            <!-- Configuration -->
            <div class="glass-panel p-3 mb-4">
                <h6 class="mb-3 text-uppercase text-muted" style="font-size: 0.75rem; letter-spacing: 1px;">
                    Configuration</h6>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label text-muted small">Fly API Token</label>
                        <input type="password" class="glass-input w-100" id="flyApiToken"
                            placeholder="Run 'fly auth token' to get this">
                        <small class="text-muted">Required for all Fly.io operations</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-muted small">App Name</label>
                        <input type="text" class="glass-input w-100" id="flyAppName" value="gbot-fly-worker">
                        <small class="text-muted">Unique identifier for your Fly app</small>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <h5 class="mb-3">Setup & Provisioning</h5>
                    <div class="d-grid gap-3">
                        <button class="glass-button glass-button-primary w-100" onclick="initializeFlyApp()">
                            <i class="fas fa-plus-circle me-2"></i>Initialize Fly App
                        </button>
                        <button class="glass-button glass-button-primary w-100" onclick="deployFlyImage()">
                            <i class="fas fa-hammer me-2"></i>Build & Deploy Image
                        </button>
                    </div>
                </div>
                <div class="col-md-6">
                    <h5 class="mb-3">Inspection & Cleanup</h5>
                    <div class="d-grid gap-3">
                        <button class="glass-button w-100" onclick="checkFlyAppStatus()">
                            <i class="fas fa-search me-2"></i>Check App Status
                        </button>
                        <button class="glass-button glass-button-danger w-100" onclick="destroyFlyApp()">
                            <i class="fas fa-trash-alt me-2"></i>Destroy App (All Resources)
                        </button>
                    </div>
                </div>
            </div>

            <!-- Resource Configuration -->
            <div class="glass-panel p-3">
                <h6 class="mb-3 text-uppercase text-muted" style="font-size: 0.75rem;">Machine Defaults</h6>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label text-muted small">CPU Type</label>
                        <select class="glass-input w-100" id="cpuType">
                            <option value="shared">Shared CPU</option>
                            <option value="performance" selected>Performance (Dedicated)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-muted small">Memory (GB)</label>
                        <input type="number" class="glass-input w-100" id="memorySize" value="4" min="1" max="16">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-muted small">Default Region</label>
                        <select class="glass-input w-100" id="defaultRegion">
                            <option value="iad">US East (Ashburn)</option>
                            <option value="lax">US West (LA)</option>
                            <option value="lhr" selected>Europe (London)</option>
                            <option value="fra">Europe (Frankfurt)</option>
                            <option value="ams">Europe (Amsterdam)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-muted small">Auto-destroy</label>
                        <select class="glass-input w-100" id="autoDestroy">
                            <option value="true" selected>Enabled</option>
                            <option value="false">Disabled</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Machines -->
        <div id="tab-machines" class="tab-content" style="display: none;">
            <h4 class="mb-4 glass-text-primary">Machine Management</h4>

            <!-- Controls -->
            <div class="d-grid gap-3 d-md-flex mb-4">
                <button class="glass-button glass-button-primary flex-grow-1" onclick="createTestMachine()">
                    <i class="fas fa-plus me-2"></i>Create Test Machine
                </button>
                <button class="glass-button flex-grow-1" onclick="listAllMachines()">
                    <i class="fas fa-list me-2"></i>List All Machines
                </button>
                <button class="glass-button glass-button-danger flex-grow-1" onclick="cleanupStoppedMachines()">
                    <i class="fas fa-broom me-2"></i>Cleanup Stopped
                </button>
            </div>

            <!-- Machine List -->
            <div class="glass-panel p-0">
                <div class="p-3 border-bottom border-white-10 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Active Machines</h6>
                    <button class="glass-button btn-sm" onclick="listAllMachines()">
                        <i class="fas fa-sync me-1"></i>Refresh
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table mb-0 text-white" style="background: transparent;">
                        <thead style="background: rgba(255,255,255,0.05);">
                            <tr>
                                <th class="p-3">Machine ID</th>
                                <th class="p-3">Region</th>
                                <th class="p-3">State</th>
                                <th class="p-3">Created</th>
                                <th class="p-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="machinesTableBody">
                            <tr>
                                <td colspan="5" class="text-center p-4 text-muted">No machines created yet.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Real-time Logs -->
            <div class="glass-panel p-0 mt-4">
                <div class="p-3 border-bottom border-white-10 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Live Machine Logs</h6>
                    <div class="form-check form-switch m-0">
                        <input class="form-check-input" type="checkbox" id="enableLiveLogsToggle"
                            onchange="toggleLiveLogs()">
                        <label class="form-check-label text-muted small ms-2">Stream Logs</label>
                    </div>
                </div>
                <div id="liveMachineLogs" class="p-3 font-monospace small text-white"
                    style="height: 250px; overflow-y: auto; background: #000;">
                    <div class="text-muted">Enable log streaming to view real-time output...</div>
                </div>
            </div>
        </div>

        <!-- Tab: Processing -->
        <div id="tab-processing" class="tab-content" style="display: none;">
            <h4 class="mb-4 glass-text-primary">Batch Processing</h4>

            <!-- Config -->
            <div class="glass-panel p-3 mb-4">
                <h6 class="mb-3 text-uppercase text-muted" style="font-size: 0.75rem;">Processing Configuration</h6>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label text-muted small">Batch Size (Users per Machine)</label>
                        <input type="number" class="glass-input w-100" id="batchSize" value="10" min="1" max="20">
                        <small class="text-muted">Recommended: 8-12 for best results</small>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-muted small">Parallel Machines</label>
                        <input type="number" class="glass-input w-100" id="parallelMachines" value="4" min="1" max="10">
                        <small class="text-muted">Max concurrent machines</small>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-muted small">Region Distribution</label>
                        <select class="glass-input w-100" id="regionDistribution">
                            <option value="single">Single Region</option>
                            <option value="multi" selected>Multi-Region (IP Diversity)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Account Input -->
            <div class="mb-4">
                <label class="form-label text-muted small">Account Input (email:password[:recovery])</label>
                <textarea id="accountsInput" class="glass-input w-100 font-monospace mb-2" rows="8"
                    placeholder="user1@example.com:password1:recovery1&#10;user2@example.com:password2:recovery2"></textarea>
                <div id="accountsStatus" class="small text-success">Ready to process</div>
            </div>

            <!-- Actions -->
            <div class="d-grid gap-3">
                <button type="button" id="processButton" class="glass-button glass-button-primary py-3 w-100"
                    onclick="startBatchProcessing()">
                    <i class="fas fa-play me-2"></i>Start Batch Processing
                </button>
                <div class="d-flex gap-3">
                    <button type="button" class="glass-button glass-button-danger flex-grow-1"
                        onclick="stopAllProcessing()">
                        <i class="fas fa-stop me-2"></i>Stop All
                    </button>
                    <button type="button" class="glass-button flex-grow-1" onclick="clearResults()">
                        <i class="fas fa-eraser me-2"></i>Clear Results
                    </button>
                </div>
            </div>

            <!-- Results -->
            <div class="glass-panel p-3 mt-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">Generated App Passwords</h6>
                    <div>
                        <button class="glass-button btn-sm me-2" onclick="fetchResults()">
                            <i class="fas fa-sync me-1"></i>Refresh
                        </button>
                        <button class="glass-button btn-sm" onclick="exportResults()">
                            <i class="fas fa-download me-1"></i>Export
                        </button>
                    </div>
                </div>
                <textarea id="resultsOutput" class="glass-input w-100 font-monospace" rows="8" readonly></textarea>
            </div>
        </div>

        <!-- Tab: Status -->
        <div id="tab-status" class="tab-content" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="mb-0">Global Status Overview</h4>
                <button class="glass-button glass-button-primary" onclick="checkGlobalFlyStatus()">
                    <i class="fas fa-sync me-2"></i>Refresh Status
                </button>
            </div>

            <div id="globalStatusLoading" class="text-center py-5" style="display: none;">
                <div class="loading-spinner mb-3 mx-auto"></div>
                <p class="text-muted">Checking all Fly.io resources...</p>
            </div>

            <!-- Status Cards -->
            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="glass-panel p-3">
                        <div class="text-muted small mb-1">Total Apps</div>
                        <div class="h3 mb-0 text-white" id="statusTotalApps">-</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="glass-panel p-3">
                        <div class="text-muted small mb-1">Running Machines</div>
                        <div class="h3 mb-0 text-success" id="statusRunningMachines">-</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="glass-panel p-3">
                        <div class="text-muted small mb-1">Stopped Machines</div>
                        <div class="h3 mb-0 text-warning" id="statusStoppedMachines">-</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="glass-panel p-3">
                        <div class="text-muted small mb-1">Total Regions</div>
                        <div class="h3 mb-0 text-info" id="statusTotalRegions">-</div>
                    </div>
                </div>
            </div>

            <!-- Detailed Table -->
            <div class="table-container glass-panel p-0 overflow-hidden">
                <table class="table mb-0 text-white" style="background: transparent;">
                    <thead style="background: rgba(255,255,255,0.05);">
                        <tr>
                            <th class="p-3">App Name</th>
                            <th class="p-3">Status</th>
                            <th class="p-3">Machines</th>
                            <th class="p-3">Region(s)</th>
                            <th class="p-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="statusTableBody">
                        <tr>
                            <td colspan="5" class="text-center p-4 text-muted">No status data yet. Click "Refresh
                                Status" to scan.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Log Output -->
<div class="glass-panel p-0 mt-4">
    <div class="p-3 border-bottom border-white-10 bg-black-20">
        <h5 class="m-0 font-monospace text-muted small text-uppercase">
            <i class="fas fa-terminal me-2"></i>System Log
        </h5>
    </div>
    <div id="logOutput" class="p-3 font-monospace small text-muted"
        style="height: 300px; overflow-y: auto; white-space: pre-wrap;"></div>
</div>

<style>
    .tab-content {
        display: none;
        animation: fadeIn 0.3s ease-in-out;
    }

    .tab-content.active {
        display: block;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(5px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<script>
    // Logging function
    function log(message) {
        const logOutput = document.getElementById('logOutput');
        const timestamp = new Date().toLocaleTimeString();
        const logLine = `[${timestamp}] ${message}\n`;
        logOutput.textContent += logLine;
        logOutput.scrollTop = logOutput.scrollHeight;
        console.log(logLine);
    }

    // Tab switching
    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
            tab.style.display = 'none';
        });
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });

        const tab = document.getElementById(`tab-${tabId}`);
        const btn = document.getElementById(`tab-${tabId}-btn`);

        if (tab) {
            tab.classList.add('active');
            tab.style.display = 'block';
        }
        if (btn) {
            btn.classList.add('active');
        }
    }

    // Initialize
    log('Fly.io Management Interface Loaded');

    // ============================================================================
    // INFRASTRUCTURE TAB FUNCTIONS
    // ============================================================================

    async function initializeFlyApp() {
        const token = document.getElementById('flyApiToken').value;
        const appName = document.getElementById('flyAppName').value;

        if (!token || !appName) {
            alert('Please provide both API Token and App Name');
            return;
        }

        log(`Initializing Fly app: ${appName}...`);

        try {
            const res = await fetch('/api/fly/initialize-app', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token, app_name: appName })
            });
            const data = await res.json();

            if (data.success) {
                log(`✅ App initialized: ${data.message}`);
                alert(`Success: ${data.message}`);
            } else {
                log(`❌ Failed: ${data.error}`);
                alert(`Error: ${data.error}`);
            }
        } catch (e) {
            log(`❌ Error: ${e.message}`);
            alert(`Error: ${e.message}`);
        }
    }

    async function deployFlyImage() {
        const token = document.getElementById('flyApiToken').value;
        const appName = document.getElementById('flyAppName').value;

        if (!token || !appName) {
            alert('Please provide both API Token and App Name');
            return;
        }

        log(`Deploying image for ${appName}... This may take several minutes.`);

        try {
            const res = await fetch('/api/fly/deploy-image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token, app_name: appName })
            });
            const data = await res.json();

            if (data.success) {
                log(`✅ Deployment started: ${data.message}`);
                alert(`Deployment initiated. Check logs for progress.`);
            } else {
                log(`❌ Failed: ${data.error}`);
                alert(`Error: ${data.error}`);
            }
        } catch (e) {
            log(`❌ Error: ${e.message}`);
            alert(`Error: ${e.message}`);
        }
    }

    async function checkFlyAppStatus() {
        const token = document.getElementById('flyApiToken').value;
        const appName = document.getElementById('flyAppName').value;

        log(`Checking status for ${appName}...`);

        try {
            const res = await fetch('/api/fly/check-app-status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token, app_name: appName })
            });
            const data = await res.json();

            if (data.success) {
                log(`✅ Status: ${data.status}`);
                log(`   Details: ${JSON.stringify(data.details, null, 2)}`);
            } else {
                log(`❌ Failed: ${data.error}`);
            }
        } catch (e) {
            log(`❌ Error: ${e.message}`);
        }
    }

    async function destroyFlyApp() {
        if (!confirm('⚠️ This will destroy the entire app and all machines. Continue?')) return;

        const token = document.getElementById('flyApiToken').value;
        const appName = document.getElementById('flyAppName').value;

        log(`Destroying app: ${appName}...`);

        try {
            const res = await fetch('/api/fly/destroy-app', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token, app_name: appName })
            });
            const data = await res.json();

            if (data.success) {
                log(`✅ App destroyed successfully`);
                alert('App destroyed');
            } else {
                log(`❌ Failed: ${data.error}`);
            }
        } catch (e) {
            log(`❌ Error: ${e.message}`);
        }
    }

    // ============================================================================
    // MACHINES TAB FUNCTIONS
    // ============================================================================

    async function listAllMachines() {
        const token = document.getElementById('flyApiToken').value;
        const appName = document.getElementById('flyAppName').value;

        log('Listing all machines...');

        try {
            const res = await fetch('/api/fly/list-machines', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token, app_name: appName })
            });
            const data = await res.json();

            const tbody = document.getElementById('machinesTableBody');
            tbody.innerHTML = '';

            if (data.machines && data.machines.length > 0) {
                data.machines.forEach(m => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="p-3"><code>${m.id}</code></td>
                        <td class="p-3">${m.region}</td>
                        <td class="p-3"><span class="badge ${m.state === 'started' ? 'badge-success' : 'badge-secondary'}">${m.state}</span></td>
                        <td class="p-3">${new Date(m.created_at).toLocaleString()}</td>
                        <td class="p-3">
                            <button class="glass-button btn-sm" onclick="destroyMachine('${m.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                log(`✅ Found ${data.machines.length} machine(s)`);
            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-muted">No machines found.</td></tr>';
                log('No machines found');
            }
        } catch (e) {
            log(`❌ Error: ${e.message}`);
        }
    }

    async function createTestMachine() {
        const token = document.getElementById('flyApiToken').value;
        const appName = document.getElementById('flyAppName').value;
        const region = document.getElementById('defaultRegion').value;

        log(`Creating test machine in region ${region}...`);

        try {
            const res = await fetch('/api/fly/create-machine', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token, app_name: appName, region })
            });
            const data = await res.json();

            if (data.success) {
                log(`✅ Machine created: ${data.machine_id}`);
                listAllMachines();
            } else {
                log(`❌ Failed: ${data.error}`);
            }
        } catch (e) {
            log(`❌ Error: ${e.message}`);
        }
    }

    async function cleanupStoppedMachines() {
        if (!confirm('Remove all stopped machines?')) return;

        const token = document.getElementById('flyApiToken').value;
        const appName = document.getElementById('flyAppName').value;

        log('Cleaning up stopped machines...');

        try {
            const res = await fetch('/api/fly/cleanup-machines', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token, app_name: appName })
            });
            const data = await res.json();

            if (data.success) {
                log(`✅ Cleaned up ${data.removed_count} machine(s)`);
                listAllMachines();
            } else {
                log(`❌ Failed: ${data.error}`);
            }
        } catch (e) {
            log(`❌ Error: ${e.message}`);
        }
    }

    function toggleLiveLogs() {
        const enabled = document.getElementById('enableLiveLogsToggle').checked;

        if (enabled) {
            log('Starting live log stream...');
            // TODO: Implement EventSource for /api/fly/stream-logs
        } else {
            log('Stopping live log stream...');
        }
    }

    // ============================================================================
    // PROCESSING TAB FUNCTIONS
    // ============================================================================

    async function startBatchProcessing() {
        const token = document.getElementById('flyApiToken').value;
        const appName = document.getElementById('flyAppName').value;
        const accountsText = document.getElementById('accountsInput').value;
        const batchSize = parseInt(document.getElementById('batchSize').value);

        if (!accountsText.trim()) {
            alert('Please provide account list');
            return;
        }

        const accounts = accountsText.split('\n').filter(l => l.trim());
        log(`Starting batch processing for ${accounts.length} accounts (batch size: ${batchSize})...`);

        try {
            const res = await fetch('/api/fly/process-batch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    token,
                    app_name: appName,
                    accounts,
                    batch_size: batchSize
                })
            });
            const data = await res.json();

            if (data.success) {
                log(`✅ Processing started: ${data.message}`);
            } else {
                log(`❌ Failed: ${data.error}`);
            }
        } catch (e) {
            log(`❌ Error: ${e.message}`);
        }
    }

    async function fetchResults() {
        log('Fetching results from database...');

        try {
            const res = await fetch('/api/fly/results');
            const data = await res.json();

            const output = document.getElementById('resultsOutput');
            if (data.results && data.results.length > 0) {
                output.value = data.results.map(r => `${r.email}:${r.app_password}`).join('\n');
                log(`✅ Loaded ${data.results.length} result(s)`);
            } else {
                output.value = 'No results yet';
                log('No results found');
            }
        } catch (e) {
            log(`❌ Error: ${e.message}`);
        }
    }

    function exportResults() {
        const text = document.getElementById('resultsOutput').value;
        if (!text || text === 'No results yet') {
            alert('No results to export');
            return;
        }

        const blob = new Blob([text], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `fly_results_${new Date().getTime()}.txt`;
        a.click();
        log('✅ Results exported');
    }

    function clearResults() {
        if (!confirm('Clear all results from database?')) return;
        // TODO: Implement
        log('Clear results not yet implemented');
    }

    function stopAllProcessing() {
        // TODO: Implement
        log('Stop processing not yet implemented');
    }

    // ============================================================================
    // STATUS TAB FUNCTIONS
    // ============================================================================

    async function checkGlobalFlyStatus() {
        const loading = document.getElementById('globalStatusLoading');
        loading.style.display = 'block';

        log('Checking global Fly.io status...');

        try {
            const res = await fetch('/api/fly/global-status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    token: document.getElementById('flyApiToken').value
                })
            });
            const data = await res.json();

            if (data.success) {
                // Update status cards
                document.getElementById('statusTotalApps').textContent = data.total_apps || 0;
                document.getElementById('statusRunningMachines').textContent = data.running_machines || 0;
                document.getElementById('statusStoppedMachines').textContent = data.stopped_machines || 0;
                document.getElementById('statusTotalRegions').textContent = data.total_regions || 0;

                // Update table
                const tbody = document.getElementById('statusTableBody');
                tbody.innerHTML = '';

                if (data.apps && data.apps.length > 0) {
                    data.apps.forEach(app => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td class="p-3">${app.name}</td>
                            <td class="p-3"><span class="badge badge-${app.status === 'running' ? 'success' : 'secondary'}">${app.status}</span></td>
                            <td class="p-3">${app.machine_count}</td>
                            <td class="p-3">${app.regions.join(', ')}</td>
                            <td class="p-3">
                                <button class="glass-button btn-sm" onclick="viewAppDetails('${app.name}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }

                log(`✅ Status check complete`);
            } else {
                log(`❌ Failed: ${data.error}`);
            }
        } catch (e) {
            log(`❌ Error: ${e.message}`);
        } finally {
            loading.style.display = 'none';
        }
    }
</script>
{% endblock %}