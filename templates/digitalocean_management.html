{% extends "base.html" %}

{% block title %}DigitalOcean Management{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4">
                <i class="fab fa-digital-ocean text-primary"></i>
                DigitalOcean Management
            </h1>
        </div>
    </div>

    <!-- Initial Droplet Setup Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fa fa-rocket"></i> Initial Droplet Setup
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        <i class="fa fa-info-circle"></i>
                        Create your first droplet with your automation script installed, then snapshot it for bulk
                        execution.
                        <br><small>Configure API credentials in <a href="/settings">Settings</a> first.</small>
                    </p>

                    <form id="createDropletForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Droplet Name</label>
                                <input type="text" class="form-control" id="dropletName"
                                    placeholder="automation-master-01" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Region</label>
                                <select class="form-select" id="region" required>
                                    <option value="">Loading...</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Size</label>
                                <select class="form-select" id="size" required>
                                    <option value="">Loading...</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label class="form-label">SSH Public Key (for access)</label>
                                <textarea class="form-control" id="sshKey" rows="3"
                                    placeholder="ssh-rsa AAAAB3NzaC1..."></textarea>
                                <small class="text-muted">Leave empty to use password authentication</small>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success">
                                <i class="fa fa-plus"></i> Create Initial Droplet
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="loadRegionsAndSizes()">
                                <i class="fa fa-sync"></i> Reload Regions/Sizes
                            </button>
                        </div>
                    </form>

                    <div id="createDropletMessages" class="mt-3"></div>

                    <!-- Snapshot Creation Section -->
                    <div id="snapshotSection" class="mt-4 pt-4 border-top" style="display: none;">
                        <h6 class="mb-3">
                            <i class="fa fa-camera"></i> Create Automation Snapshot
                        </h6>
                        <p class="text-muted mb-3">
                            Once your droplet is configured with the automation script, create a snapshot for bulk
                            execution.
                        </p>
                        <form id="createSnapshotForm">
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label class="form-label">Snapshot Name</label>
                                    <input type="text" class="form-control" id="snapshotName"
                                        placeholder="automation-snapshot-v1" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Droplet to Snapshot</label>
                                    <select class="form-select" id="dropletToSnapshot" required>
                                        <option value="">Select a droplet</option>
                                    </select>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-warning">
                                <i class="fa fa-camera"></i> Create Snapshot
                            </button>
                        </form>
                        <div id="createSnapshotMessages" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Droplets and Snapshots Row -->
    <div class="row">
        <!-- Droplets Section -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fa fa-server"></i> Active Droplets
                    </h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-sm btn-primary mb-3" onclick="loadDroplets()">
                        <i class="fa fa-sync"></i> Refresh List
                    </button>
                    <div id="dropletsList" class="table-responsive">
                        <p class="text-muted">Click refresh to load droplets</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Snapshots Section -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fa fa-camera"></i> Snapshots
                    </h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-sm btn-primary mb-3" onclick="loadSnapshots()">
                        <i class="fa fa-sync"></i> Refresh List
                    </button>
                    <div id="snapshotsList" class="table-responsive">
                        <p class="text-muted">Click refresh to load snapshots</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Execution Section (Future Feature) -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-secondary">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fa fa-rocket"></i> Bulk Automation Execution
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fa fa-info-circle"></i>
                        <strong>Coming Soon:</strong> Bulk execution feature will be added in a future update. This will
                        allow you to distribute users across multiple droplets and execute app password automation.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Load regions and sizes on page load
    $(document).ready(function () {
        loadRegionsAndSizes();
        loadDroplets(); // Also check for existing droplets to enable snapshot section
    });

    // Load Regions and Sizes
    function loadRegionsAndSizes() {
        // Load regions
        $.ajax({
            url: '/api/do/regions',
            method: 'GET',
            success: function (response) {
                if (response.success) {
                    const regionSelect = $('#region');
                    regionSelect.html('<option value="">Select a region</option>');
                    response.regions.forEach(function (region) {
                        regionSelect.append(`<option value="${region.slug}">${region.name}</option>`);
                    });
                }
            },
            error: function () {
                $('#region').html('<option value="">Error loading regions</option>');
            }
        });

        // Load sizes
        $.ajax({
            url: '/api/do/sizes',
            method: 'GET',
            success: function (response) {
                if (response.success) {
                    const sizeSelect = $('#size');
                    sizeSelect.html('<option value="">Select a size</option>');
                    response.sizes.forEach(function (size) {
                        const price = size.price_monthly ? ` ($${size.price_monthly}/mo)` : '';
                        sizeSelect.append(`<option value="${size.slug}">${size.description}${price}</option>`);
                    });
                }
            },
            error: function () {
                $('#size').html('<option value="">Error loading sizes</option>');
            }
        });
    }

    // Create Droplet
    $('#createDropletForm').on('submit', function (e) {
        e.preventDefault();

        const droplet = {
            name: $('#dropletName').val().trim(),
            region: $('#region').val(),
            size: $('#size').val(),
            ssh_key: $('#sshKey').val().trim()
        };

        if (!droplet.name || !droplet.region || !droplet.size) {
            showMessage('createDropletMessages', 'Please fill in all required fields', 'danger');
            return;
        }

        showMessage('createDropletMessages', 'Creating droplet... This may take a few minutes.', 'info');

        $.ajax({
            url: '/api/do/droplets/create',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(droplet),
            success: function (response) {
                if (response.success) {
                    showMessage('createDropletMessages', `✅ Droplet created successfully! IP: ${response.ip_address}`, 'success');
                    // Show snapshot section
                    $('#snapshotSection').show();
                    // Refresh droplet list
                    loadDroplets();
                    // Reset form
                    $('#createDropletForm')[0].reset();
                } else {
                    showMessage('createDropletMessages', `❌ Failed to create droplet: ${response.error}`, 'danger');
                }
            },
            error: function (xhr) {
                const error = xhr.responseJSON?.error || 'Failed to create droplet';
                showMessage('createDropletMessages', `❌ Error: ${error}`, 'danger');
            }
        });
    });

    // Create Snapshot
    $('#createSnapshotForm').on('submit', function (e) {
        e.preventDefault();

        const snapshot = {
            droplet_id: $('#dropletToSnapshot').val(),
            name: $('#snapshotName').val().trim()
        };

        if (!snapshot.droplet_id || !snapshot.name) {
            showMessage('createSnapshotMessages', 'Please select a droplet and provide a snapshot name', 'danger');
            return;
        }

        showMessage('createSnapshotMessages', 'Creating snapshot... This may take several minutes.', 'info');

        $.ajax({
            url: `/api/do/droplets/${snapshot.droplet_id}/snapshot`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ name: snapshot.name }),
            success: function (response) {
                if (response.success) {
                    showMessage('createSnapshotMessages', `✅ Snapshot created successfully! ID: ${response.snapshot_id}`, 'success');
                    // Refresh snapshots list
                    loadSnapshots();
                    // Reset form
                    $('#createSnapshotForm')[0].reset();
                } else {
                    showMessage('createSnapshotMessages', `❌ Failed to create snapshot: ${response.error}`, 'danger');
                }
            },
            error: function (xhr) {
                const error = xhr.responseJSON?.error || 'Failed to create snapshot';
                showMessage('createSnapshotMessages', `❌ Error: ${error}`, 'danger');
            }
        });
    });

    // Load Droplets
    function loadDroplets() {
        $.ajax({
            url: '/api/do/droplets',
            method: 'GET',
            success: function (response) {
                if (response.success) {
                    renderDroplets(response.droplets);

                    // Populate droplet selection for snapshot creation
                    const dropletSelect = $('#dropletToSnapshot');
                    dropletSelect.html('<option value="">Select a droplet</option>');
                    response.droplets.forEach(function (droplet) {
                        if (droplet.status === 'active') {
                            dropletSelect.append(`<option value="${droplet.id}">${droplet.name} (${droplet.ip_address})</option>`);
                        }
                    });

                    // Show snapshot section if there are droplets
                    if (response.droplets.length > 0) {
                        $('#snapshotSection').show();
                    }
                } else {
                    showMessage('dropletsList', response.error || 'Failed to load droplets', 'danger');
                }
            },
            error: function (xhr) {
                const error = xhr.responseJSON?.error || 'Failed to load droplets';
                $('#dropletsList').html('<div class="alert alert-danger">' + error + '</div>');
            }
        });
    }

    // Render Droplets
    function renderDroplets(droplets) {
        if (!droplets || droplets.length === 0) {
            $('#dropletsList').html('<p class="text-muted">No droplets found</p>');
            return;
        }

        let html = '<table class="table table-sm"><thead><tr>' +
            '<th>Name</th><th>IP</th><th>Region</th><th>Size</th><th>Status</th><th>Actions</th>' +
            '</tr></thead><tbody>';

        droplets.forEach(function (droplet) {
            const statusClass = droplet.status === 'active' ? 'success' : 'warning';
            html += `<tr>
            <td>${droplet.name}</td>
            <td><code>${droplet.ip_address || 'N/A'}</code></td>
            <td>${droplet.region}</td>
            <td>${droplet.size}</td>
            <td><span class="badge bg-${statusClass}">${droplet.status}</span></td>
            <td>
                <button class="btn btn-sm btn-danger" onclick="deleteDroplet('${droplet.id}', '${droplet.name}')">
                    <i class="fa fa-trash"></i>
                </button>
            </td>
        </tr>`;
        });

        html += '</tbody></table>';
        $('#dropletsList').html(html);
    }

    // Delete Droplet
    function deleteDroplet(dropletId, dropletName) {
        if (!confirm(`Delete droplet "${dropletName}"?`)) {
            return;
        }

        $.ajax({
            url: '/api/do/droplets/' + dropletId,
            method: 'DELETE',
            success: function (response) {
                if (response.success) {
                    alert('Droplet deleted successfully');
                    loadDroplets();
                } else {
                    alert('Failed to delete droplet: ' + (response.error || 'Unknown error'));
                }
            },
            error: function (xhr) {
                const error = xhr.responseJSON?.error || 'Failed to delete droplet';
                alert('Error: ' + error);
            }
        });
    }

    // Load Snapshots
    function loadSnapshots() {
        $.ajax({
            url: '/api/do/snapshots',
            method: 'GET',
            success: function (response) {
                if (response.success) {
                    renderSnapshots(response.snapshots);
                } else {
                    showMessage('snapshotsList', response.error || 'Failed to load snapshots', 'danger');
                }
            },
            error: function (xhr) {
                const error = xhr.responseJSON?.error || 'Failed to load snapshots';
                $('#snapshotsList').html('<div class="alert alert-danger">' + error + '</div>');
            }
        });
    }

    // Render Snapshots
    function renderSnapshots(snapshots) {
        if (!snapshots || snapshots.length === 0) {
            $('#snapshotsList').html('<p class="text-muted">No snapshots found</p>');
            return;
        }

        let html = '<table class="table table-sm"><thead><tr>' +
            '<th>Name</th><th>Size (GB)</th><th>Regions</th><th>Actions</th>' +
            '</tr></thead><tbody>';

        snapshots.forEach(function (snapshot) {
            const regions = snapshot.regions.join(', ');
            html += `<tr>
            <td>${snapshot.name}</td>
            <td>${snapshot.size_gigabytes}</td>
            <td>${regions}</td>
            <td>
                <button class="btn btn-sm btn-danger" onclick="deleteSnapshot('${snapshot.id}', '${snapshot.name}')">
                    <i class="fa fa-trash"></i>
                </button>
            </td>
        </tr>`;
        });

        html += '</tbody></table>';
        $('#snapshotsList').html(html);
    }

    // Delete Snapshot
    function deleteSnapshot(snapshotId, snapshotName) {
        if (!confirm(`Delete snapshot "${snapshotName}"?`)) {
            return;
        }

        $.ajax({
            url: '/api/do/snapshots/' + snapshotId,
            method: 'DELETE',
            success: function (response) {
                if (response.success) {
                    alert('Snapshot deleted successfully');
                    loadSnapshots();
                } else {
                    alert('Failed to delete snapshot: ' + (response.error || 'Unknown error'));
                }
            },
            error: function (xhr) {
                const error = xhr.responseJSON?.error || 'Failed to delete snapshot';
                alert('Error: ' + error);
            }
        });
    }

    // Helper: Show Message
    function showMessage(elementId, message, type) {
        const alertClass = 'alert-' + type;
        const html = '<div class="alert ' + alertClass + ' alert-dismissible fade show" role="alert">' +
            message +
            '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
            '</div>';
        $('#' + elementId).html(html);
    }
</script>

<style>
    .card {
        border-radius: 8px;
    }

    .card-header {
        border-radius: 8px 8px 0 0;
    }

    code {
        font-size: 0.85em;
    }
</style>
{% endblock %}