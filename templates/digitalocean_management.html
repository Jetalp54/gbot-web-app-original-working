{% extends "base.html" %}

{% block title %}DigitalOcean Management{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4">
                <i class="fab fa-digital-ocean text-primary"></i>
                DigitalOcean Management
            </h1>
        </div>
    </div>

    <!-- Initial Droplet Setup Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fa fa-rocket"></i> Initial Droplet Setup
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        <i class="fa fa-info-circle"></i>
                        Create your first droplet with your automation script installed, then snapshot it for bulk
                        execution.
                        <br><small>Configure API credentials in <a href="/settings">Settings</a> first.</small>
                    </p>

                    <form id="createDropletForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Droplet Name</label>
                                <input type="text" class="form-control" id="dropletName"
                                    placeholder="automation-master-01" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Region</label>
                                <select class="form-select" id="region" required>
                                    <option value="">Loading...</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Size</label>
                                <select class="form-select" id="size" required>
                                    <option value="">Loading...</option>
                                </select>
                            </div>
                        </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12 mb-3">
                    <label class="form-label">Authentication Method</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="authMethod" id="authSSH" value="ssh" checked
                            onchange="toggleAuthMethod()">
                        <label class="btn btn-outline-primary" for="authSSH">
                            <i class="fab fa-ssh"></i> SSH Key
                        </label>

                        <input type="radio" class="btn-check" name="authMethod" id="authPassword" value="password"
                            onchange="toggleAuthMethod()">
                        <label class="btn btn-outline-primary" for="authPassword">
                            <i class="fa fa-key"></i> Root Password
                        </label>
                    </div>
                </div>
            </div>
            <div class="row" id="sshKeySection">
                <div class="col-12 mb-3">
                    <div class="alert alert-info">
                        <i class="fa fa-info-circle"></i> Using configured SSH Key from Settings.
                    </div>
                </div>
            </div>
            <div class="row" id="passwordSection" style="display: none;">
                <div class="col-12 mb-3">
                    <label class="form-label">Root Password</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="rootPassword" placeholder="e.g. Batata010..++"
                            value="Batata010..++">
                        <button class="btn btn-outline-secondary" type="button"
                            onclick="copyToClipboard($('#rootPassword').val())">
                            <i class="fa fa-copy"></i>
                        </button>
                    </div>
                    <small class="text-danger">
                        <i class="fa fa-exclamation-triangle"></i>
                        Must be complex: Uppercase, lowercase, number, and special character.
                    </small>
                </div>
            </div>
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-success">
                    <i class="fa fa-plus"></i> Create Initial Droplet
                </button>
                <button type="button" class="btn btn-secondary" onclick="loadRegionsAndSizes()">
                    <i class="fa fa-sync"></i> Reload Regions/Sizes
                </button>
            </div>
            </form>

            <div id="createDropletMessages" class="mt-3"></div>

            <!-- Snapshot Creation Section -->
            <div id="snapshotSection" class="mt-4 pt-4 border-top" style="display: none;">
                <h6 class="mb-3">
                    <i class="fa fa-camera"></i> Create Automation Snapshot
                </h6>
                <p class="text-muted mb-3">
                    Once your droplet is configured with the automation script, create a snapshot for bulk
                    execution.
                </p>
                <form id="createSnapshotForm">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label">Snapshot Name</label>
                            <input type="text" class="form-control" id="snapshotName"
                                placeholder="automation-snapshot-v1" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Droplet to Snapshot</label>
                            <select class="form-select" id="dropletToSnapshot" required>
                                <option value="">Select a droplet</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-warning">
                        <i class="fa fa-camera"></i> Create Snapshot
                    </button>
                </form>
                <div id="createSnapshotMessages" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>
</div>

<!-- Droplets and Snapshots Row -->
<div class="row">
    <!-- Droplets Section -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fa fa-server"></i> Active Droplets
                </h5>
            </div>
            <div class="card-body">
                <button class="btn btn-sm btn-primary mb-3" onclick="loadDroplets()">
                    <i class="fa fa-sync"></i> Refresh List
                </button>
                <div id="dropletsList" class="table-responsive">
                    <p class="text-muted">Click refresh to load droplets</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Snapshots Section -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fa fa-camera"></i> Snapshots
                </h5>
            </div>
            <div class="card-body">
                <button class="btn btn-sm btn-primary mb-3" onclick="loadSnapshots()">
                    <i class="fa fa-sync"></i> Refresh List
                </button>
                <div id="snapshotsList" class="table-responsive">
                    <p class="text-muted">Click refresh to load snapshots</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Automation Execution Section -->
<div class="row">
    <div class="col-12">
        <div class="card shadow-sm border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fa fa-rocket"></i> Bulk Automation Execution
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    <i class="fa fa-info-circle"></i>
                    Distribute users across multiple droplets for parallel app password automation.
                    <br><small>Requires a configured snapshot ID from Settings.</small>
                </p>

                <form id="bulkExecutionForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Users (Email:Password format, one per line)</label>
                            <textarea class="form-control font-monospace" id="bulkUsers" rows="5"
                                placeholder="user1@domain.com:password1&#10;user2@domain.com:password2"
                                required></textarea>
                            <small class="text-muted">Format: email:password (one per line)</small>
                        </div>
                        <div class="col-md-6">
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <label class="form-label">Number of Droplets</label>
                                    <input type="number" class="form-control" id="dropletCount" min="1" max="50"
                                        value="5" required>
                                    <small class="text-muted">Users will be distributed evenly</small>
                                </div>
                                <div class="col-12 mb-3">
                                    <label class="form-label">Snapshot ID (from snapshots above)</label>
                                    <input type="text" class="form-control" id="snapshotId" placeholder="123456789"
                                        required>
                                </div>
                                <div class="col-6 mb-3">
                                    <label class="form-label">Region</label>
                                    <select class="form-select" id="bulkRegion">
                                        <option value="">Use default</option>
                                    </select>
                                </div>
                                <div class="col-6 mb-3">
                                    <label class="form-label">Size</label>
                                    <select class="form-select" id="bulkSize">
                                        <option value="">Use default</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" id="autoDestroy" checked>
                        <label class="form-check-label" for="autoDestroy">
                            Auto-destroy droplets after execution
                        </label>
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fa fa-play"></i> Start Bulk Execution
                    </button>
                </form>

                <div id="bulkExecutionMessages" class="mt-3"></div>

                <!-- Progress Section -->
                <div id="executionProgress" class="mt-4" style="display: none;">
                    <h6><i class="fa fa-spinner fa-spin"></i> Execution In Progress</h6>
                    <div class="alert alert-info">
                        <strong>Execution ID:</strong> <span id="executionId"></span><br>
                        <strong>Total Users:</strong> <span id="totalUsersProgress"></span><br>
                        <strong>Droplets:</strong> <span id="dropletsProgress"></span><br>
                        <small>Check droplets section above to monitor active droplets.</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View Generated App Passwords Section -->
<div class="row">
    <div class="col-12">
        <div class="card shadow-sm border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fa fa-key"></i> Generated App Passwords
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    <i class="fa fa-info-circle"></i>
                    View app passwords generated from bulk automation executions.
                </p>

                <button type="button" class="btn btn-success" onclick="loadGeneratedPasswords()">
                    <i class="fa fa-refresh"></i> Load Generated Passwords
                </button>

                <div id="passwordsMessages" class="mt-3"></div>

                <div id="passwordsList" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>
</div>

<!-- Test Automation Modal -->
<div class="modal fade" id="testAutomationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Test Automation Script</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">Run the automation script on this droplet to verify it works before creating a
                    snapshot.</p>

                <!-- Test Form -->
                <form id="testAutomationForm">
                    <input type="hidden" id="testDropletId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="testEmail" required
                                placeholder="user@domain.com">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Password</label>
                            <input type="text" class="form-control" id="testPassword" required placeholder="password">
                        </div>
                    </div>
                </form>

                <div class="d-flex justify-content-between align-items-center mb-2">
                    <button type="button" class="btn btn-primary" onclick="runTestAutomation()">
                        <i class="fa fa-play"></i> Run Test
                    </button>
                    <button type="button" class="btn btn-outline-dark btn-sm" onclick="toggleSetupLogs()">
                        <i class="fa fa-terminal"></i> Toggle Setup Logs
                    </button>
                </div>

                <div id="testAutomationResult" class="mt-3"></div>

                <!-- Embedded Setup Logs (Hidden by default) -->
                <div id="embeddedSetupLogs" class="mt-3" style="display: none;">
                    <h6><i class="fa fa-terminal"></i> Cloud-Init Setup Logs</h6>
                    <pre id="setupLogsContent" class="text-success p-3 m-0 font-monospace rounded"
                        style="white-space: pre-wrap; max-height: 300px; overflow-y: auto; font-size: 0.75rem; background-color: #1a1a1a; color: #00ff00;">Loading...</pre>
                    <small class="text-muted">Auto-refreshing every 3s...</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    // === Global Variables ===
    let currentExecutionId = null;  // Track current bulk execution

    // === Page Initialization ===
    $(document).ready(function () {
        loadRegionsAndSizes();
        loadSnapshots();
        loadDroplets();
    });

    // === Load Regions and Sizes ===
    function loadRegionsAndSizes() {
        $.ajax({
            url: '/api/do/regions-sizes',
            method: 'GET',
            success: function (response) {
                if (response.success) {
                    // Populate initial droplet creation form - Regions
                    const regionSelect = $('#region');
                    regionSelect.html('<option value="">Select a region</option>');
                    // Populate bulk execution form - Regions
                    const bulkRegionSelect = $('#bulkRegion');
                    bulkRegionSelect.html('<option value="">Use default</option>');

                    response.regions.forEach(function (region) {
                        regionSelect.append(`<option value="${region.slug}">${region.name}</option>`);
                        bulkRegionSelect.append(`<option value="${region.slug}">${region.name}</option>`);
                    });

                    // Populate initial droplet creation form - Sizes
                    const sizeSelect = $('#size');
                    sizeSelect.html('<option value="">Select a size</option>');
                    // Populate bulk execution form - Sizes
                    const bulkSizeSelect = $('#bulkSize');
                    bulkSizeSelect.html('<option value="">Use default</option>');

                    response.sizes.forEach(function (size) {
                        const price = size.price_monthly ? ` ($${size.price_monthly}/mo)` : '';
                        sizeSelect.append(`<option value="${size.slug}">${size.description}${price}</option>`);
                        bulkSizeSelect.append(`<option value="${size.slug}">${size.description}${price}</option>`);
                    });
                }
            },
            error: function () {
                $('#region').html('<option value="">Error loading regions</option>');
                $('#size').html('<option value="">Error loading sizes</option>');
            }
        });
    }

    // === Auth Method Toggle ===
    function toggleAuthMethod() {
        const method = $('input[name="authMethod"]:checked').val();
        if (method === 'ssh') {
            $('#sshKeySection').show();
            $('#passwordSection').hide();
        } else {
            $('#sshKeySection').hide();
            $('#passwordSection').show();
        }
    }

    // Create Droplet
    $('#createDropletForm').on('submit', function (e) {
        e.preventDefault();

        const authMethod = $('input[name="authMethod"]:checked').val();

        const droplet = {
            name: $('#dropletName').val().trim(),
            region: $('#region').val(),
            size: $('#size').val(),
            // Backend will use the configured SSH key from Settings if authMethod is ssh
            ssh_key: null,
            root_password: authMethod === 'password' ? $('#rootPassword').val().trim() : null
        };

        if (!droplet.name || !droplet.region || !droplet.size) {
            showMessage('createDropletMessages', 'Please fill in all required fields', 'danger');
            return;
        }

        if (authMethod === 'password' && !droplet.root_password) {
            showMessage('createDropletMessages', 'Root password is required', 'danger');
            return;
        }

        showMessage('createDropletMessages', 'Creating droplet... This may take a few minutes.', 'info');

        $.ajax({
            url: '/api/do/droplets/create',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(droplet),
            success: function (response) {
                if (response.success) {
                    showMessage('createDropletMessages', `‚úÖ Droplet created successfully! IP: ${response.ip_address}`, 'success');
                    // Show snapshot section
                    $('#snapshotSection').show();
                    // Refresh droplet list
                    loadDroplets();
                    // Reset form but keep password preference
                    const currentAuth = $('input[name="authMethod"]:checked').val();
                    $('#createDropletForm')[0].reset();
                    $(`input[name="authMethod"][value="${currentAuth}"]`).prop('checked', true);
                    toggleAuthMethod();
                } else {
                    showMessage('createDropletMessages', `‚ùå Failed to create droplet: ${response.error}`, 'danger');
                }
            },
            error: function (xhr) {
                const error = xhr.responseJSON?.error || 'Failed to create droplet';
                showMessage('createDropletMessages', `‚ùå Error: ${error}`, 'danger');
            }
        });
    });

    // Create Snapshot
    $('#createSnapshotForm').on('submit', function (e) {
        e.preventDefault();

        const snapshot = {
            droplet_id: $('#dropletToSnapshot').val(),
            name: $('#snapshotName').val().trim()
        };

        if (!snapshot.droplet_id || !snapshot.name) {
            showMessage('createSnapshotMessages', 'Please select a droplet and provide a snapshot name', 'danger');
            return;
        }

        showMessage('createSnapshotMessages', '‚è≥ Requesting snapshot creation... This runs in the background.', 'info');

        $.ajax({
            url: `/api/do/droplets/${snapshot.droplet_id}/snapshot`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ name: snapshot.name }),
            success: function (response) {
                if (response.success) {
                    showMessage('createSnapshotMessages', `‚úÖ Snapshot started! ID: ${response.snapshot_id || 'Pending'} (Check list below in a few mins)`, 'success');
                    // Refresh snapshots list
                    loadSnapshots();
                    // Reset form
                    $('#createSnapshotForm')[0].reset();
                } else {
                    showMessage('createSnapshotMessages', `‚ùå Failed to start snapshot: ${response.error}`, 'danger');
                }
            },
            error: function (xhr) {
                const error = xhr.responseJSON?.error || 'Failed to create snapshot';
                showMessage('createSnapshotMessages', `‚ùå Error: ${error}`, 'danger');
            }
        });
    });

    // Bulk Execution Form Submit
    $('#bulkExecutionForm').on('submit', function (e) {
        e.preventDefault();

        // Parse users from textarea
        const usersText = $('#bulkUsers').val().trim();
        const lines = usersText.split('\n').filter(line => line.trim());

        const users = [];
        for (const line of lines) {
            const parts = line.trim().split(':');
            if (parts.length >= 2) {
                users.push({
                    email: parts[0].trim(),
                    password: parts.slice(1).join(':')  // Handle passwords with colons
                });
            }
        }

        if (users.length === 0) {
            showMessage('bulkExecutionMessages', 'Please enter at least one user', 'danger');
            return;
        }

        const totalUsers = users.length;
        const dropletCount = parseInt($('#dropletCount').val());

        const executionData = {
            users: users,
            droplet_count: dropletCount,
            snapshot_id: $('#snapshotId').val().trim(),
            region: $('#bulkRegion').val() || '',
            size: $('#bulkSize').val() || '',
            auto_destroy: $('#autoDestroy').is(':checked')
        };

        // Validate
        if (!executionData.snapshot_id) {
            showMessage('bulkExecutionMessages', 'Snapshot ID is required', 'danger');
            return;
        }

        showMessage('bulkExecutionMessages', '‚è≥ Starting bulk execution...', 'info');

        $.ajax({
            url: '/api/do/execute',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(executionData),
            success: function (response) {
                if (response.success) {
                    // Store execution ID for password viewing
                    currentExecutionId = response.execution_id;

                    showMessage('bulkExecutionMessages', `‚úÖ Bulk execution started! Execution ID: ${response.execution_id}`, 'success');

                    // Show progress section
                    $('#executionProgress').show();
                    $('#executionId').text(response.execution_id);
                    $('#totalUsersProgress').text(totalUsers);
                    $('#dropletsProgress').text('0'); // Initial count

                    // Start polling Execution Status
                    const pollInterval = setInterval(function () {
                        checkExecutionStatus(response.execution_id, pollInterval);
                    }, 5000);  // Every 5 seconds

                    // Form is NOT reset so user keeps their settings

                } else {
                    showMessage('bulkExecutionMessages', `‚ùå Failed to start execution: ${response.error}`, 'danger');
                }
            },
            error: function (xhr) {
                const error = xhr.responseJSON?.error || 'Failed to start execution';
                showMessage('bulkExecutionMessages', `‚ùå Error: ${error}`, 'danger');
            }
        });
    });
    // === End of Page Initialization ===

    // Check Execution Status
    function checkExecutionStatus(executionId, intervalId) {
        $.ajax({
            url: `/api/do/execution/${executionId}/status`,
            method: 'GET',
            success: function (response) {
                if (response.success) {
                    // Update progress UI
                    $('#dropletsProgress').text(response.droplets_created);

                    // Update status badge/text if you have one, or just the progress counters

                    if (response.completed) {
                        clearInterval(intervalId); // Stop polling

                        // Refresh droplet list one last time to capture any final states
                        loadDroplets();

                        if (response.status === 'completed') {
                            showMessage('bulkExecutionMessages', `‚úÖ Execution Completed Successfully! (Success: ${response.success_count}, Failed: ${response.failure_count})`, 'success');

                            // Auto-scroll to password section
                            $('html, body').animate({
                                scrollTop: $('#passwordsList').offset().top - 100
                            }, 500);

                        } else {
                            // Failed
                            showMessage('bulkExecutionMessages', `‚ùå Execution Failed: ${response.error_message}`, 'danger');
                        }
                    }
                }
            },
            error: function (xhr) {
                console.error("Error checking status:", xhr);
                // Don't stop polling on transient network errors, but maybe log it
            }
        });
    }

    // Load Droplets
    function loadDroplets() {
        $.ajax({
            url: '/api/do/droplets',
            method: 'GET',
            success: function (response) {
                if (response.success) {
                    renderDroplets(response.droplets);

                    // Populate droplet selection for snapshot creation
                    const dropletSelect = $('#dropletToSnapshot');
                    dropletSelect.html('<option value="">Select a droplet</option>');
                    response.droplets.forEach(function (droplet) {
                        if (droplet.status === 'active') {
                            dropletSelect.append(`<option value="${droplet.id}">${droplet.name} (${droplet.ip_address})</option>`);
                        }
                    });

                    // Show snapshot section if there are droplets
                    if (response.droplets.length > 0) {
                        $('#snapshotSection').show();
                    }
                } else {
                    showMessage('dropletsList', response.error || 'Failed to load droplets', 'danger');
                }
            },
            error: function (xhr) {
                const error = xhr.responseJSON?.error || 'Failed to load droplets';
                $('#dropletsList').html('<div class="alert alert-danger">' + error + '</div>');
            }
        });
    }

    // Render Droplets
    function renderDroplets(droplets) {
        if (!droplets || droplets.length === 0) {
            $('#dropletsList').html('<p class="text-muted">No droplets found</p>');
            return;
        }

        let html = '<table class="table table-sm"><thead><tr>' +
            '<th>Name</th><th>IP</th><th>Region</th><th>Size</th><th>Status</th><th>Actions</th>' +
            '</tr></thead><tbody>';

        droplets.forEach(function (droplet) {
            const statusClass = droplet.status === 'active' ? 'success' : 'warning';
            html += `<tr>
            <td>${droplet.name}</td>
            <td><code>${droplet.ip_address || 'N/A'}</code></td>
            <td>${droplet.region}</td>
            <td>${droplet.size}</td>
            <td><span class="badge bg-${statusClass}">${droplet.status}</span></td>
            <td>
                <button class="btn btn-sm btn-info text-white me-1" onclick="openTestAutomationModal('${droplet.id}')" title="Test Automation">
                    <i class="fa fa-bug"></i> Test
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteDroplet('${droplet.id}', '${droplet.name}')">
                    <i class="fa fa-trash"></i>
                </button>
            </td>
        </tr>`;
        });

        html += '</tbody></table>';
        $('#dropletsList').html(html);
    }

    // Delete Droplet
    function deleteDroplet(dropletId, dropletName) {
        if (!confirm(`Delete droplet "${dropletName}"?`)) {
            return;
        }

        $.ajax({
            url: '/api/do/droplets/' + dropletId,
            method: 'DELETE',
            success: function (response) {
                if (response.success) {
                    alert('Droplet deleted successfully');
                    loadDroplets();
                } else {
                    alert('Failed to delete droplet: ' + (response.error || 'Unknown error'));
                }
            },
            error: function (xhr) {
                const error = xhr.responseJSON?.error || 'Failed to delete droplet';
                alert('Error: ' + error);
            }
        });
    }

    // Load Snapshots
    function loadSnapshots() {
        $.ajax({
            url: '/api/do/snapshots',
            method: 'GET',
            success: function (response) {
                if (response.success) {
                    renderSnapshots(response.snapshots);
                } else {
                    showMessage('snapshotsList', response.error || 'Failed to load snapshots', 'danger');
                }
            },
            error: function (xhr) {
                const error = xhr.responseJSON?.error || 'Failed to load snapshots';
                $('#snapshotsList').html('<div class="alert alert-danger">' + error + '</div>');
            }
        });
    }

    // Render Snapshots
    function renderSnapshots(snapshots) {
        if (!snapshots || snapshots.length === 0) {
            $('#snapshotsList').html('<p class="text-muted">No snapshots found</p>');
            return;
        }

        let html = '<table class="table table-sm"><thead><tr>' +
            '<th>Name</th><th>ID</th><th>Size (GB)</th><th>Regions</th><th>Actions</th>' +
            '</tr></thead><tbody>';

        snapshots.forEach(function (snapshot) {
            // Check if this is our automation snapshot
            const isAuto = snapshot.name.toLowerCase().includes('automation');
            const rowClass = isAuto ? 'table-success' : '';

            html += `<tr class="${rowClass}">
            <td>${snapshot.name}</td>
            <td>
                <code>${snapshot.id}</code>
                <button class="btn btn-sm btn-link p-0 ms-1 text-muted" onclick="copyToClipboard('${snapshot.id}')">
                    <i class="fa fa-copy"></i>
                </button>
            </td>
            <td>${snapshot.size_gigabytes} GB</td>
            <td>${snapshot.regions.join(', ')}</td>
            <td>
                <button class="btn btn-sm btn-danger" onclick="deleteSnapshot('${snapshot.id}', '${snapshot.name}')">
                    <i class="fa fa-trash"></i>
                </button>
            </td>
        </tr>`;
        });

        html += '</tbody></table>';
        $('#snapshotsList').html(html);
    }

    // Delete Snapshot
    function deleteSnapshot(snapshotId, snapshotName) {
        if (!confirm(`Delete snapshot "${snapshotName}"?`)) {
            return;
        }

        $.ajax({
            url: '/api/do/snapshots/' + snapshotId,
            method: 'DELETE',
            success: function (response) {
                if (response.success) {
                    alert('Snapshot deleted successfully');
                    loadSnapshots();
                } else {
                    alert('Failed to delete snapshot: ' + (response.error || 'Unknown error'));
                }
            },
            error: function (xhr) {
                const error = xhr.responseJSON?.error || 'Failed to delete snapshot';
                alert('Error: ' + error);
            }
        });
    }

    // Load Generated Passwords
    function loadGeneratedPasswords() {
        if (!currentExecutionId) {
            showMessage('passwordsMessages', '‚ö†Ô∏è No execution found. Please run a bulk execution first.', 'warning');
            return;
        }

        showMessage('passwordsMessages', `‚è≥ Loading passwords from execution: ${currentExecutionId}...`, 'info');

        $.ajax({
            url: '/api/do/generated-passwords/' + currentExecutionId,
            method: 'GET',
            success: function (response) {
                if (response.success) {
                    if (response.passwords.length === 0) {
                        showMessage('passwordsMessages', 'üì≠ No app passwords found for this execution.', 'warning');
                        $('#passwordsList').html('');
                    } else {
                        showMessage('passwordsMessages', `‚úÖ Loaded ${response.passwords.length} passwords from execution ${currentExecutionId}`, 'success');
                        renderPasswords(response.passwords);
                    }
                } else {
                    showMessage('passwordsMessages', `‚ùå ${response.error}`, 'danger');
                }
            },
            error: function (xhr) {
                const error = xhr.responseJSON?.error || 'Failed to load passwords';
                showMessage('passwordsMessages', `‚ùå Error: ${error}`, 'danger');
            }
        });
    }

    // Render Passwords Table
    function renderPasswords(passwords) {
        let html = '<div class="table-responsive mt-3"><table class="table table-sm table-striped">';
        html += '<thead class="table-dark"><tr>';
        html += '<th>#</th><th>Email</th><th>App Password</th><th>Created</th><th>Actions</th>';
        html += '</tr></thead><tbody>';

        passwords.forEach(function (pwd, index) {
            const createdDate = pwd.created_at ? new Date(pwd.created_at).toLocaleString() : 'N/A';
            html += `<tr>
                <td>${index + 1}</td>
                <td>${pwd.email}</td>
                <td><code>${pwd.app_password}</code></td>
                <td><small>${createdDate}</small></td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="navigator.clipboard.writeText('${pwd.app_password}')">
                        <i class="fa fa-copy"></i>
                    </button>
                </td>
            </tr>`;
        });

        html += '</tbody></table></div>';
        $('#passwordsList').html(html);
    }

    // Helper: Show Message
    function showMessage(elementId, message, type) {
        const alertClass = 'alert-' + type;
        const html = '<div class="alert ' + alertClass + ' alert-dismissible fade show" role="alert">' +
            message +
            '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
            '</div>';
        $('#' + elementId).html(html);
    }

    // === Test Automation Functions ===
    function openTestAutomationModal(dropletId) {
        $('#testDropletId').val(dropletId);
        $('#testAutomationResult').html('');
        $('#testAutomationForm')[0].reset();
        new bootstrap.Modal('#testAutomationModal').show();
    }

    function runTestAutomation() {
        const dropletId = $('#testDropletId').val();
        const email = $('#testEmail').val().trim();
        const password = $('#testPassword').val().trim();

        if (!email || !password) {
            $('#testAutomationResult').html('<div class="alert alert-danger">Email and password are required</div>');
            return;
        }

        $('#testAutomationResult').html('<div class="alert alert-info"><i class="fa fa-spinner fa-spin"></i> Running test... This may take a minute.</div>');

        $.ajax({
            url: `/api/do/droplets/${dropletId}/test-automation`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ email: email, password: password }),
            success: function (response) {
                if (response.success) {
                    const result = response.result;
                    let html = `<div class="alert alert-success">
                        <strong>‚úÖ Test Passed!</strong><br>
                        App Password: <code>${result.app_password || 'N/A'}</code>
                    </div>`;

                    if (result.stdout) {
                        html += `<div class="mt-2"><small><strong>Stdout:</strong></small><pre class="bg-light p-2 border" style="max-height: 200px; font-size: 0.8em;">${result.stdout}</pre></div>`;
                    }

                    $('#testAutomationResult').html(html);
                } else {
                    let errorMsg = response.error || (response.result && response.result.error) || 'Unknown error';
                    let html = `<div class="alert alert-danger">
                        <strong>‚ùå Test Failed:</strong> ${errorMsg}
                    </div>`;

                    if (response.result) {
                        if (response.result.stdout) {
                            html += `<div class="mt-2"><small><strong>Stdout:</strong></small><pre class="bg-light p-2 border" style="max-height: 200px; font-size: 0.8em;">${response.result.stdout}</pre></div>`;
                        }
                        if (response.result.stderr) {
                            html += `<div class="mt-2"><small><strong>Stderr:</strong></small><pre class="bg-light p-2 border text-danger" style="max-height: 200px; font-size: 0.8em;">${response.result.stderr}</pre></div>`;
                        }
                    }

                    $('#testAutomationResult').html(html);
                }
            },
            error: function (xhr) {
                // Try to get error from responseJSON.error OR responseJSON.result.error
                const error = xhr.responseJSON?.error || (xhr.responseJSON?.result && xhr.responseJSON.result.error) || 'Failed to run test';
                $('#testAutomationResult').html(`<div class="alert alert-danger"><strong>Error:</strong> ${error}</div>`);
            }
        });
    }

    // === Setup Logs Functions (Integrated) ===
    let logPollInterval = null;

    function toggleSetupLogs() {
        const logsDiv = $('#embeddedSetupLogs');
        const isVisible = logsDiv.is(':visible');

        if (isVisible) {
            logsDiv.hide();
            if (logPollInterval) clearInterval(logPollInterval);
        } else {
            logsDiv.show();
            const dropletId = $('#testDropletId').val();
            // Start polling
            fetchSetupLogs(dropletId);
            if (logPollInterval) clearInterval(logPollInterval);
            logPollInterval = setInterval(() => fetchSetupLogs(dropletId), 3000);
        }
    }

    function fetchSetupLogs(dropletId) {
        // If modal/logs closed, stop polling
        if (!$('#testAutomationModal').hasClass('show') || !$('#embeddedSetupLogs').is(':visible')) {
            if (logPollInterval) clearInterval(logPollInterval);
            return;
        }

        $.ajax({
            url: `/api/do/droplets/${dropletId}/setup-logs`,
            method: 'GET',
            success: function (response) {
                if (response.success) {
                    const logs = response.logs || 'No logs yet...';
                    const pre = $('#setupLogsContent');

                    if (pre.text() !== logs) {
                        pre.text(logs);
                        pre.scrollTop(pre[0].scrollHeight);
                    }
                } else {
                    $('#setupLogsContent').text(`Error fetching logs: ${response.error}`);
                }
            },
            error: function (xhr) {
                console.error("Log fetch error:", xhr);
            }
        });
    }

    // Stop polling when modal closes
    $('#testAutomationModal').on('hidden.bs.modal', function () {
        if (logPollInterval) clearInterval(logPollInterval);
        $('#embeddedSetupLogs').hide(); // Reset state
    });
</script>

<style>
    .card {
        border-radius: 8px;
    }

    .card-header {
        border-radius: 8px 8px 0 0;
    }

    code {
        font-size: 0.85em;
    }
</style>
{% endblock %}